#!/usr/bin/env bash
set -euo pipefail

INSTALL_DIR="{{ .chezmoi.sourceDir }}/../install"
source "$INSTALL_DIR/common/functions.sh"

echo "=== Starting bootstrap for {{ .chezmoi.os }} ==="

{{- if eq .chezmoi.os "darwin" }}
# macOS: Xcode CLT → Homebrew → Brewfile
run_scripts "$INSTALL_DIR/macos" "10" "20" "30"

{{- else if eq .chezmoi.os "linux" }}
# Ubuntu: 共通スクリプト実行
run_scripts "$INSTALL_DIR/ubuntu" "10" "20" "30"

# common → desktop/server 分岐
run_scripts "$INSTALL_DIR/ubuntu/common" "10" "20" "30"

if is_ubuntu_desktop; then
  echo "→ Running Ubuntu Desktop specific scripts"
  run_scripts "$INSTALL_DIR/ubuntu/desktop" "10" "20" "30"
elif is_ubuntu_server; then
  echo "→ Running Ubuntu Server specific scripts"
  run_scripts "$INSTALL_DIR/ubuntu/server" "10" "20" "30"
fi

{{- else }}
echo "⚠ Unsupported OS: {{ .chezmoi.os }}"
exit 1
{{- end }}

# nvim config のシンボリックリンク
if [[ -d "$HOME/dotfiles/nvim" ]]; then
  mkdir -p "$HOME/.config"
  ln -sfn "$HOME/dotfiles/nvim" "$HOME/.config/nvim"
  echo "✓ nvim config symlinked"
elif [[ -d "$HOME/.local/share/chezmoi/home/dot_config/nvim" ]]; then
  # chezmoi manage している場合は不要（chezmoi apply で自動配置される）
  echo "✓ nvim config managed by chezmoi"
fi

echo "=== Bootstrap completed for {{ .chezmoi.os }} ==="