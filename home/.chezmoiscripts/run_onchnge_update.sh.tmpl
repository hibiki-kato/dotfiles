#!/usr/bin/env bash
set -euo pipefail

SCRIPTS_DIR="$HOME/.chezmoiscripts"
source "$SCRIPTS_DIR/common/functions.sh"

echo "=== Updating packages for {{ .chezmoi.os }} ==="

{{- if eq .chezmoi.os "darwin" }}
# Brewfile のハッシュ: {{ include "darwin/Brewfile" | sha256sum }}
if command -v brew >/dev/null 2>&1; then
  eval "$(brew shellenv)"
  
  if [[ -f "$HOME/.Brewfile" ]]; then
    brew bundle --global
  elif [[ -f "$SCRIPTS_DIR/darwin/Brewfile" ]]; then
    brew bundle --file="$SCRIPTS_DIR/darwin/Brewfile"
  fi
  
  brew upgrade
  brew cleanup
  echo "✓ Homebrew packages updated"
fi

{{- else if eq .chezmoi.os "linux" }}
# Linux: apt update → upgrade
if command -v apt >/dev/null 2>&1; then
  sudo apt update
  sudo apt upgrade -y
  sudo apt autoremove -y
  echo "✓ apt packages updated"
fi

{{- end }}

echo "=== Update completed for {{ .chezmoi.os }} ==="